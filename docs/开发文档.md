# Ticket System 开发文档

## 分工

|  组员  |          分工          |
| :----: | :--------------------: |
| 范棋珈 | 后端逻辑、前端（暂定） |
|  韦捷  |         B+ 树          |

## 程序功能概述

- 程序最终呈现一个和12306相类似的火车票管理系统。
- 程序首次创建账户时不需要指定当前用户，并且默认用户优先级为10（最高优先级）。

- 指令中第一个部分必须为指令关键词，指令中关键词部分必须与指令格式完全匹配。

- 系统支持嵌套登录，即允许多个账户同时处于登录状态
- `quit` 和 `exit` 指令功能为正常退出系统，退出系统视为登出所有已登录账户
- 

#### 指令列表简述：

`add_user`[N] 

- 参数列表

  `<cur_username>`  `<username>`  `<password>`  `<name>`  `<mailAddr>`

  `-c -u -p -n -m -g`

- 说明

  当前用户`<cur_username>`为`-c`，创建一个`<username>`为`-u`，`<password>`为`-p`，`<name>`为`-n`，`<mailAddr>`为`-m`，`<privilege>`为`-g`的用户。

  权限要求：`-c`已登录，且新用户的权限低于`-c`的权限。

  特别地，创建第一个用户时，新用户权限为`10`，不受上述权限规则约束。具体来讲，当创建第一个用户时，忽略`-c`和`-g`参数，并认为新用户优先级为`10`。

- 返回值

  注册成功：`0`

  注册失败：`-1`

[F] `login`

- 参数列表

  `-u -p`

- 说明

  以`-u`为`<username>`，`-p`为`<password>`登录。若登录成功，当前用户列表增加此用户。第一次进入系统时，当前用户为空。

- 返回值

  登录成功：`0`

  登录失败：`-1`

[F] `logout`

- 参数列表

  `-u`

- 说明

  `<username>`为`-u`的用户退出登录。若退出成功，将此用户移出当前用户列表。

- 返回值

  登出成功：`0`

  登出失败：`-1`

[SF] `query_profile`

- 参数列表

  `-c -u`

- 说明

  `<username>`为`-c`的用户查询`<username>`为`-u`的用户信息。

  权限要求：`-c`已登录，且「`-c`的权限大于`-u`的权限，或是`-c`和`-u`相同」。

- 返回值

  查询成功：一行字符串，依次为被查询用户的`<username>`，`<name>`，`<mailAddr>`和`<privilege>`，用一个空格隔开。

  查询失败：`-1`

[F] `modify_profile`

- 参数列表

  `-c -u (-p) (-n) (-m) (-g)`

- 说明

  `<username>`为`-c`的用户修改`<username>`为`-u`的用户信息。修改参数同注册参数，且均可以省略。

  权限要求：`-c`已登录，且「`-c`的权限大于`-u`的权限，或是`-c`和`-u`相同」，且`-g`需低于`-c`的权限。

- 返回值

  修改成功：返回被修改用户的信息，格式同`query_profile`。

  修改失败：`-1`

[N] `add_train`

- 参数列表

  `-i -n -m -s -p -x -t -o -d -y`

- 说明

  添加`<trainID>`为`-i`，`<stationNum>`为`-n`，`<seatNum>`为`-m`，`<stations>`为`-s`，`<prices>`为`-p`，`<startTime>`为`-x`，`<travelTimes>`为`-t`，`<stopoverTimes>`为`-o`，`<saleDate>`为`-d`，`<type>`为`-y`的车次。

  由于`-s`、`-p`、`-t`、`-o`和`-d`由多个值组成，输入时两个值之间以`|`隔开（仍是一个不含空格的字符串）。

- 返回值

  添加成功：`0`

  添加失败：`-1`

- 举例：

  `> add_train -i HAPPY_TRAIN -n 3 -m 1000 -s 上院|中院|下院 -p 114|514 -x 19:19 -t 600|600 -o 5 -d 06-01|08-17 -y G`

  `0`

[N] `release_train`

- 参数列表

  `-i`

- 说明

  将`<trainID>`为`-i`的车次发布。发布前的车次可被删除，不可发售车票；发布后的车次不可被删除，可发售车票。

- 返回值

  发布成功：`0`

  发布失败：`-1`

- 举例：

  `> release_train -i HAPPY_TRAIN `

  `0`

[N] `query_train`

- 参数列表

  `-i -d`

- 说明

  查询在日期`-d`发车的，`<trainID>`为`-i`的车次的情况，`-d`的格式为`mm-dd`。

- 返回值

  查询成功：输出共`(<stationNum> + 1)`行。

   第一行为`<trainID> <type>`

   接下来`<stationNum>`行，第`i`行为`<stations[i]> <ARRIVING_TIME> -> <LEAVING_TIME> <PRICE> <SEAT>`，其中`<ARRIVING_TIME>`和`<LEAVING_TIME>`为列车到达本站和离开本站的绝对时间，格式为`mm-dd hr:mi`。`<PRICE>`为从始发站乘坐至该站的累计票价，`<SEAT>`为从该站到下一站的剩余票数。对于始发站的到达时间和终点站的出发时间，所有数字均用`x`代替；终点站的剩余票数用`x`代替。

  查询失败：`-1`

- 举例

  （上接添加列车的例子）

  `> query_train -d 07-01 -i HAPPY_TRAIN`

  `HAPPY_TRAIN G`

  `上院 xx-xx xx:xx -> 07-01 19:19 0 1000`

  `中院 07-02 05:19 -> 07-02 05:24 114 1000`

  `下院 07-02 15:24 -> xx-xx xx:xx 628 x`

[N] `delete_train`

- 参数列表

  `-i`

- 说明

  删除`<trainID>`为`-i`的车次。

- 返回值

  删除成功：`0`

  删除失败：`-1`

[SF] `query_ticket`

- 参数列表

  `-s -t -d (-p time)`

- 说明

  查询日期为`-d`时从`-s`出发，并到达`-t`的车票。请注意：这里的日期是列车从`-s`出发的日期，不是从列车始发站出发的日期。

  `-p`的值为`time`和`cost`中的一个，若为`time`表示输出按照该车次所需时间从小到大排序，否则按照票价从低到高排序。

- 返回值

  查询成功： 第一行输出一个整数，表示符合要求的车次数量。

  接下来每一行输出一个符合要求的车次，按要求排序。格式为`<trainID> <FROM> <LEAVING_TIME> -> <TO> <ARRIVING_TIME> <PRICE> <SEAT>`，其中出发时间、到达时间格式同`query_train`，`<FROM>`和`<TO>`为出发站和到达站，`<PRICE>`为累计价格，`<SEAT>`为最多能购买的票数。

  查询失败：`-1`

- 样例

  （上接查询列车的例子）

  `> query_ticket -s 中院 -t 下院 -d 08-17`

  `1`

  `HAPPY_TRAIN 中院 08-17 05:24 -> 下院 08-17 15:24 514 1000`

[N] `query_transfer`

参数列表及其意义同`query_ticket`。

- 说明

  在恰好换乘一次的情况下查询符合条件的车次，仅输出最优解。

- 返回值

  查询失败（没有符合要求的车次）：`0`

  查询成功：输出2行，换乘中搭乘的两个车次，格式同`query_ticket`。

[SF] `buy_ticket`

- 参数列表 `-u -i -d -n -f -t (-q false)`

- 说明

  `<username>`为`-u`的用户购买：`<trainID>`为`-i`，日期为`-d`，从站`-f`到站`-t`的车票`-n`张。

  `-q`可选`false`或`true`，若为`true`，表明在**余票不足**的情况下愿意接受候补购票，当有余票时**立即**视为此用户购买了车票。

  权限要求：`-u`已登录。

- 返回值

  购买成功：一个整数，表示订单总价。

  加入候补：`queue`

  购票失败：`-1`

- 样例

  （上接查询车票的例子，假设用户均已登录）

  `> buy_ticket -u Texas -i HAPPY_TRAIN -d 08-17 -n 800 -f 中院 -t 下院`

  `411200`

  `> buy_ticket -u Lappland -i HAPPY_TRAIN -d 08-16 -n 500 -f 上院 -t 下院 -q true`

  `queue`

- 样例解释

  用户`Texas`购买了8.17从中院出发的火车票800张，在上面的`add_train`操作中，8.16从上院出发的火车会在8.17到达中院，所以事实上`Lappland`试图购买的票的火车和`Texas`是同一辆车，所以`Lappland`购买不了500张票。

[F] `query_order`

- 参数列表

  `-u`

- 说明

  查询`<username>`为`-u`的用户的所有订单信息，按照交易时间顺序从新到旧排序（候补订单即使补票成功，交易时间也以下单时刻为准）。

  权限要求：`-u`已登录。

- 返回值

  查询成功：第一行输出一个整数，表示订单数量。

  接下来每一行表示一个订单，格式为`[<STATUS>] <trainID> <FROM> <LEAVING_TIME> -> <TO> <ARRIVING_TIME> <PRICE> <NUM>`，其中`<NUM>`为购票数量，`<STATUS>`表示该订单的状态，可能的值为：`success`（购票已成功）、`pending`（位于候补购票队列中）和`refunded`（已经退票）。

  查询失败：`-1`

- 样例

  `> query_order -u Lappland`

  `1`

  `[pending] HAPPY_TRAIN 上院 08-17 05:24 -> 下院 08-17 15:24 628 500`

[N] `refund_ticket`

- 参数列表

  `-u (-n 1)`

- 说明

  `<username>`为`-u`的用户退订从新到旧（即`query_order`的返回顺序）第`-n`个订单。

  权限要求：`-u`已登录。

- 返回值

  退票成功：`0`

  退票失败：`-1`

[R] `clean`

- 参数列表

  无

- 说明

  清除所有数据。

- 返回值

  `0`

[R] `exit`

- 参数列表

  无

- 说明

  退出程序，所有在线用户均下线。

- 返回值

  `bye`





## 主体逻辑说明

#### 运行 Operating

- 首先调用 `void init()` 先检查文件是否存在，如不存在，则建立文件。
- 构造 `UserManagement` 、 `TrainManagement`、 `LogManagement`等类。
- 程序为一个循环，在输入终止指令后退出程序。
- 每次读入一行，输入 token_scanner，分析输入内容，调用函数。



## 存储结构

#### 主要内存：

- 登录表

- 已发布的车次

- 候补队列

- 

#### 维护以下的B+树(外存）：

- username  ——> 用户信息（或者其存储位置）

- trainID ——> 火车信息（或者其存储位置）

- （站名，trainID）——> 火车信息存储位置

- （日期，trainID）——> 火车信息存储位置

- （username，时刻）——> 操作信息

- 

*注：每个文件以二进制方式储存，最小储存单元为一个 class，每次写入或读入一个 class，其长度可用 `sizeof()` 获得。注意：字符类型的情况下需用 `char[<length> + 1]` 而非 `std::string` 完成，否则无法正常读写。*

#### 详细信息：

用户信息：

- `username`：**用户的唯一标识符**，由字母开头，字母、数字和下划线组成的字符串，长度不超过20。
- `password`：由字母、数字和下划线组成的字符串，长度不低于6，不超过30。
- `name`：由二至五个汉字组成的字符串。
- `mailAddr`：同一般邮箱地址格式，且仅含数字、大小写字母，`@`和`.`，长度不超过30。（无需检验邮箱格式的合法性）
- `privilege`：所处用户组优先级，为一个0~10的整数。

火车信息：

- `trainID`：**车次的唯一标识符**，由字母开头，字母、数字和下划线组成的字符串，长度不超过20。

- `stationNum`：车次经过的车站数量，为大于1且不超过100的整数。

- `stations`：车次经过的所有车站名，共`stationNum`项，站名由汉字组成，不超过10个汉字。

  **输入**格式为：`station_1｜station_2｜station_3...station_stationNum`

  **输出**格式为：`station_1 station_2 station_3 ... station_stationNum`

- `seatNum`：该车次的座位数，为不超过100000的整数。

- `prices`：每两站之间的票价，共`(stationNum - 1)`项，第`i`项表示`station_i`到`station_(i+1)`的票价，是一个不超过100000的整数。

  **输入**格式为：`price_1｜price_2｜price_3...price_(stationNum - 1)`

  **输出**格式为：`price_1 price_2 price_3 ... price_(stationNum - 1)`

- `startTime`：列车每日的发车时间，时间格式为`hr:mi`。如：`23:51`。

- `travelTimes`：每两站之间行车所用的时间（单位为分钟），共`(stationNum - 1)`项，每一项是一个不超过10000的整数。

- `stopoverTimes`：除始发站和终点站之外，列车在每一站停留的时间（单位为分钟），共`(stationNum - 2)`项，每一项是一个不超过10000的整数。

- `saleDate`：车次的售卖时间区间（闭区间），在时间区间内，每天都有相同的此车次。共2项，每一项均为2021年6月至8月的某一天，日期格式为`mm-dd`。如：`06-07｜08-17`。

- `type`：列车类型，为一个大写字母。



```c++
class TokenScanner{
private:
    //char delimiter_ = ' '; //分隔符
    int current_ = 0; //所在的位置
    std::string buffer_; //储存的字符串缓冲区
public:
    TokenScanner() = default;

    TokenScanner(std::string &);

    std::string NextToken(char delimiter_ = ' ');

    std::string NextToken(char delimiter_head_, char delimiter_tail_, bool ck = false);

    void Clear();

    bool If_left(char delimiter_ = ' ');

    std::string Getleft(char delimiter_ = ' ');


}
```

```c++
template<typename _key_type,typename _subkey_type,typename _value_type>
class BPlusTree{
private:
  
public:
  
};
```

```c++
class UserName{
  char content[21];
  UserName(std::string);
  
};

class User{
private:
  UserName username;
  
public:
  char password[31];
  char name[20];
  char mailAddr[31];
  int priviledge;
  
  User();
  User();
  
};
```

```c++
class UserManagement{
private:
  BPlusTree<username,default,User> username_map_;
  std::fstream file_user_;
public:
  UserManagement();
  UserManagement();
  
  int AddUser();
  
  int LogIn();
  
  int LogOut();
  
  std::string Query();
  
  std::string Modify();
  
  
};
```

```c++
class TrainID{
  
}

class Train{
  TrainID trainID;
};

class TrainManagement{
private:  
  BPlusTree<TrainID,default,Train> train_map_;
  std::fstream file_train_;
public:
  
  
  int Addtrain();
  
  int Release();
  
  std::string Query();
  
  int Delete();
  
  
};
```

```c++
class LogManagement{
private:  
  BPlusTree<username,int,Log> user_to_log_map_;
  std::fstream file_log_;
public:
  
  
};
```

